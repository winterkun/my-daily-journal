# 路由重定向拦截权限校验机制文档

## 一、整体流程概述

路由重定向拦截权限的校验通过多层级校验机制实现，涵盖应用启动、路由访问、页面加载及 API 请求等多个环节，结合权限判断与智能重定向策略，确保系统访问安全与用户体验平衡。

## 二、核心校验环节及实现

### 1. 应用启动时的权限初始化校验

应用启动阶段加载用户信息与权限数据，为后续校验奠定基础。



```
// packages/asmart/src/MainApp/useApp.tsx

function useApp() {

 const \[loading, setLoading] = React.useState(true);

 useDebounceEffect(

   () => {

     setLoading(true);

     // 加载用户信息和权限数据

     AppStore.load()

       .then(({ loginInfo, authorizedMenus, frontConfig }) => {

         // 用权限菜单初始化导航

         Navigation.getInstance().init(authorizedMenus);

         // 存储全局状态

         GlobalState.getInstance().setState({ currentUser: loginInfo, frontConfig });

         setLoading(false);

       })

       .catch((error) => {

         console.error(error);

         // 权限校验失败，重定向到登录页

         redirectUtils.redirectToLogin();

       });

   },

   \[],

   { wait: 100 },

 );

}
```

### 2. 路由级权限校验

在路由配置前进行权限判断，拦截无权限访问。



```
// packages/asmart/src/MainApp/index.tsx

function MainApp() {

 const { loading } = useApp();

 if (loading) {

   return \<Skeleton active />;

 }



 // 权限校验：检查用户是否有任何菜单权限

 if (Navigation.getInstance().isEmpty()) {

   return \<Result status="403" title="暂无权限" subTitle="请申请权限，审批通过后重新打开页面。" />;

 }



 return (

   \<RouterProvider

     router={createHashRouter(\[

       {

         path: '/',

         element: \<MainLayout />,

         children: \[{ path: '\*', element: null }]

       }

     ])}

   />

 );

}
```

### 3. 路由重定向机制

实时监测当前路径权限，无权限时自动重定向至合法页面。



```
// packages/asmart/src/MainLayout/useMainLayout.tsx

React.useEffect(() => {

 const nav = Navigation.getInstance();

 // 检查当前路径对应的菜单权限

 nav.getPathMenus(location.pathname).then((nodes) => {

   if (nodes.length) {

     // 有权限，设置选中的菜单节点

     changeSelectedNodes(nodes);

   } else {

     // 无权限，重定向到有权限的页面

     navigate({ pathname: nav.getRedirectPathname(location.pathname) });

   }

 });

}, [location.pathname, navigate, changeSelectedNodes]);
```

### 4. 权限校验失败的处理

统一处理权限校验失败场景，确保跳转逻辑一致。



```
// packages/aims-utils/src/redirectUtils.ts

export function redirectToLogin(loginType?: string) {

 return redirect(\`\${getLoginUrl()}?\${getLoginSearch(loginType)}\`);

}

function getLoginSearch(loginType?: string) {

 const searchParams = new URLSearchParams();

 // 保存当前页面URL，登录后可跳转回原页面

 searchParams.append(getRedirectParamField(), encodeURIComponent(window.location.href));



 // 保存租户信息

 const tenantParamField = tenantUtils.getParamField();

 const tenantId = LocationSearch.getURLSearchParam(tenantParamField);

 if (tenantId) {

   searchParams.append(tenantParamField, tenantId);

 }



 return searchParams.toString();

}
```

### 5. API 请求级权限校验

在接口请求层面拦截权限问题，及时处理 token 失效等情况。



```
// packages/aims-services/src/request.ts

const redirectToLogin = () => {

 console.log('token失效，跳转登录页');

 redirectUtils.redirectToLogin();

};

// 在请求拦截器中检查token有效性

if (response.status === 401) {

 redirectToLogin();

}
```

## 三、权限校验的层次结构

### 1. 应用级权限校验



*   应用启动时检查用户登录状态

*   验证 token 有效性

*   加载并存储用户菜单权限数据

### 2. 路由级权限校验



*   检查用户是否有访问当前路径的权限

*   无权限时触发重定向机制

### 3. 组件级权限校验

在组件内部根据权限控制元素展示。



```
// 在组件中使用权限判断

function MyComponent() {

 const hasPermission = hasPermission('POST', '/api/users', false);



 return (

   \<div>

     {hasPermission && \<button>编辑\</button>}

   \</div>

 );

}
```

### 4. API 级权限校验



*   后端验证用户 token 和接口访问权限

*   前端处理 401（未授权）、403（禁止访问）响应，触发登录重定向

## 四、重定向策略

### 1. 登录重定向



*   保存当前访问页面的 URL 信息

*   登录成功后自动跳转回原页面，恢复用户操作流程

### 2. 权限不足重定向



*   当访问无权限页面时，自动重定向到用户有权限的第一个菜单页面

*   对于完全无权限的用户，显示 403 错误提示页面

### 3. Token 失效重定向



*   检测到 token 失效（如 401 响应）时，清除本地无效 token

*   立即重定向到登录页，要求用户重新登录

## 五、机制总结

该权限校验机制通过多层级拦截（应用启动、路由访问、组件渲染、API 请求）和智能重定向策略，实现了全面的权限控制：



*   安全性：确保未授权用户无法访问受限资源，token 失效时及时拦截

*   易用性：权限不足时自动跳转至合法页面，登录后可返回原访问路径

*   清晰度：通过分层校验，使权限逻辑模块化，便于维护和扩展

*   友好性：对无权限场景提供明确提示，引导用户申请权限或重新登录
